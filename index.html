<!-- Merged 2025_10_17 -->
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" href="data:;base64,iVBORw0KGgo="><style>/* c.css */
:root{color-scheme: light dark;--base_size:13px;--light:hsl(60, 70%, 98%);--dark:hsl(15, 5%, 10%);--bg:light-dark(var(--light),var(--dark));--fg:light-dark(var(--dark),var(--light));--border: 1px solid var(--fg);--base_x1:15px;--half_base:calc(var(--base_x1)/2);--base_x15:calc(var(--base_x1) * 1.5);--base_x2:calc(var(--base_x1)*2);--border: 1px solid var(--fg);--radius: 3px}hr {border: none;height: 1px; background-color: var(--fg);}x-gap {height: 20px;display: block;}* {padding: 0;margin: 0;font-family: monospace;font-size: 15px;line-height: 130%;background: var(--bg);color: var(--fg);outline-color: var(--fg);font-size-adjust: ex-height 0.53;box-sizing: border-box;}hr {margin-bottom: 1ch;}main, .no_select{user-select: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;cursor: default;}textarea{width: 100%;border: var(--border);padding: 1ch;border-radius: var(--radius);resize: none;}html,body{background-color: var(--bg);width: 100vw;height: 100dvh;min-height: 100dvh;}header{margin: 2ch;}body {padding: 0ch 2ch;max-width: 72ch;margin:0 auto;display: flex;flex-direction: column;}main {position: relative;overflow: hidden;height: 0px;flex: 1 1 auto;}#file_picker::after{content: "Drop EPUBS anywhere to load them";font-size: 24px;padding: 1ch;display: block;position: fixed;top: 0;left: 0;text-align: center;width: 100dvw;z-index:99;opacity: 0;pointer-events: none;}#file_picker.drag::after{pointer-events: all;opacity: 1;color: var(--bg);background-color:var(--fg);}button {border-radius: var(--radius);border:var(--border);padding: 0 3px;}main button {width: 100%;margin-bottom: 1ch;}button:active {background-color: var(--fg);color: var(--bg);}button:hover {border: var(--border);}input[type='file']{padding: 3px;width: 100%;margin-bottom: 1ch;border: 1px dashed var(--fg);border-radius: var(--radius);}footer{button {border-color: transparent;}padding: 1ch 0;text-align: center;}footer,small, footer *{font-size: 12px;}p{margin-bottom: 1ch;}summary{border: var(--border);border-color: transparent;}summary:hover {border: 1px dashed var(--fg);}details div {border: 1px solid var(--fg);padding: 1ch 1ch 0ch 1ch;}[popover]{border-radius: var(--radius);position: fixed;inset: 0;height: fit-content;margin: 2ch auto;border: solid;padding: 0.25em;overflow: auto;background-color: var(--bg);width: 66ch;min-height: 6ch;border: 2px solid var(--fg);padding: 2ch;max-width: 90dvw;max-height: 90dvh;pre{white-space: pre-wrap;}button{width: 100%;display: block;margin-bottom: 2px;}}h1,h2,h3,h4{text-align: center;margin-bottom: 1ch;}h3 {font-weight: normal;}h1 {text-transform: uppercase;}small{display: block;width: 100%;text-align: right;}</style><title>Tbook — Folder per book, text file per section</title><meta name="description" content="This tool converts epubs to tbooks and saves one zip file per run."></head><body><header><h1>Batch Convert EPUBS to Tbooks</h1></header><div><input type="checkbox" id="make_content_ascii"><label title="This option only suits English texts" for="make_content_ascii">Make content ASCII </label></div><div><input type="checkbox" checked="" id="auto_save"><label for="auto_save">Auto save </label></div><input type="file" id="file_picker" accept=".epub" multiple="multiple" autofocus=""><small>(NOTE: The tool remains untested for large batch runs)</small><textarea id="textarea_txt_holder" placeholder="Any messages from the tool will appear here."></textarea><button id="save_button" disabled="" hidden="">Save TAR</button><x-gap></x-gap><p>A Tbook consists of an archived or regular folder that holds sequential MD or TXT text files. The folder represents a book and each file represents a section in the book. The file names control the section order. The folder may also contain an optional metadata file. Books with nested structures may use sub folders for hierarchy.
</p><footer><button popovertarget="popover_license">License | By + ©</button><a href="https://gregabbott.pages.dev/">Greg Abbott</a> 2024 - 2025 | <a href="log.html">Log</a> | <a href="https://github.com/gregabbott/tbook">GitHub</a></footer><div popover="" id="popover_license"><p>V1: 2024-11-11 (YMD)<br>
V : 2025_1011b.<br>
By and Copyright (c) 2024 + 2025 <a href="https://gregabbott.pages.dev/">Greg Abbott</a><br> All rights reserved.<br></p><p><b>NO WARRANTY</b><br> THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</p><hr></div><script>
</script><script>/* ga_tar.js */
const tar_lib=(()=>{function t({blob:t,name:e}){let a=document;const n=a.createElement("a");n.href=URL.createObjectURL(t),n.download=e,a.body.appendChild(n),n.click(),a.body.removeChild(n)}const e=(t,e="")=>{const a=new TextEncoder;let n=[];return t.forEach((({name:t,data:r,date:o,path:c=""})=>{let d=(t=>{if(!t.startsWith("data:"))return!1;const e=t.indexOf(",");if(e<0)return!1;const a=t.slice(5,e);return!!/;base64$/i.test(a)})(r)?(t=>{const e=atob(t.split(",")[1]),a=e.length,n=new Uint8Array(a);for(let t=0;t<a;t++)n[t]=e.charCodeAt(t);return n})(r):a.encode(r);const i=e?`${e}/${c}${t}`:`${c}${t}`,l=o?new Date(o):new Date;n.push(((t,e,a)=>{let n=t,r=a;const o=e.toString(8).padStart(11,"0")+"\0",c=new TextEncoder,d=t=>c.encode(t),i=new Uint8Array(512);var l;[[c.encode(n).slice(0,100),0],[d(o),124],[d((l=r,Math.floor(new Date(l).getTime()/1e3).toString(8).padStart(11,"0")+"\0")),136],[d("0000777\0"),100],[d("0000000\0"),108],[d("0000000\0"),116],[d("ustar  \0"),257]].forEach((t=>i.set(...t)));const s=i.reduce(((t,e)=>t+e),0)+256;return i.set(d(s.toString(8).padStart(6,"0")+"\0 "),148),i})(i,d.length,l),d),n.push(new Uint8Array((512-d.length%512)%512))})),n.push(new Uint8Array(512),new Uint8Array(512)),n},a=(t,a)=>n(e(t,a)),n=t=>new Blob(t,{type:"application/x-tar"});return{data_to_tar_blob:a,data_to_tar_data:e,data_to_tar_download:({files:e,extracted_name:n,archived_name:r})=>{t({blob:a(e,n),name:r+".tar"})},save_blob:t}})();
/* ga_process_text.js */
function process_text({ascii_wanted:e=!1}){return n=>{return t(n,(function(e){let n=" ",i=" ",c=" ",t=" ",r="​",a="‌",o="‍",u=" ";const g={[n]:u,[i]:u,[c]:u,[t]:u,[r]:"",[a]:"",[o]:""},F=RegExp(`[${Object.keys(g).join("")}]`,"g");return e.replace(F,(e=>g[e]||""))}),(function(e){return e.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,"")}),(i=e,c=function(e){return t(e,u,a,r,o,g)},e=>i?c(e):e),(function(e){return e.replace(/\n[ \t]+\n/g,"\n\n")}),(function(e){return e.replace(/\n{3,}/g,"\n\n")}),(function(e){return e.replace(/([!\.?]) {2,}/g,"$1 ")}),(function(e){return e.replace(/[ \t]+\n/g,"\n")}));var i,c;function t(e,...n){return n.reduce(((e,n)=>n(e)),e)}function r(e){const n={"🙂":"Slightly Smiling Face","😀":"Grinning Face","😁":"Beaming Face with Smiling Eyes","😂":"Face with Tears of Joy","😃":"Grinning Face with Big Eyes","😄":"Grinning Face with Smiling Eyes","😅":"Grinning Face with Sweat","😆":"Grinning Squinting Face","😉":"Winking Face","😊":"Smiling Face with Smiling Eyes","😇":"Smiling Face with Halo","🥰":"Smiling Face with Hearts","😍":"Smiling Face with Heart-Eyes","😋":"Face Savoring Food","😎":"Smiling Face with Sunglasses","😏":"Smirking Face","😒":"Unamused Face","😞":"Disappointed Face","😔":"Pensive Face","😟":"Worried Face","😠":"Angry Face","😡":"Pouting Face","😢":"Crying Face","😭":"Loudly Crying Face","😤":"Face with Steam From Nose","😩":"Weary Face","😬":"Grimacing Face","😱":"Face Screaming in Fear","😳":"Flushed Face","😵":"Dizzy Face","😶":"Face Without Mouth","🤔":"Thinking Face","🤗":"Hugging Face","🤩":"Star-Struck","🥳":"Party Face"};return e.replace(/[\u{1F600}-\u{1F64F}]/gu,(e=>n[e]?`(Emoji of ${n[e]})`:"(Unknown Emoji)"))}function a(e){const n={"⓪⓿":"0","①❶":"1","②❷":"2","③❸":"3","④❹":"4","⑤❺":"5","⑥❻":"6","⑦❼":"7","⑧❽":"8","⑨❾":"9","⑩❿":"10","⑪⓫":"11","⑫⓬":"12","⑬⓭":"13","⑭⓮":"14","⑮⓯":"15","⑯⓰":"16","⑰⓱":"17","⑱⓲":"18","⑲⓳":"19","⑳⓴":"20","⧁":">","⧀":"<","Ⓐ":"A","Ⓑ":"B","Ⓒ":"C","Ⓓ":"D","Ⓔ":"E","Ⓕ":"F","Ⓖ":"G","Ⓗ":"H","Ⓘ":"I","Ⓙ":"J","Ⓚ":"K","Ⓛ":"L","Ⓜ":"M","Ⓝ":"N","Ⓞ":"O","Ⓟ":"P","Ⓠ":"Q","Ⓡ":"R","Ⓢ":"S","Ⓣ":"T","Ⓤ":"U","Ⓥ":"V","Ⓦ":"W","Ⓧ":"X","Ⓨ":"Y","Ⓩ":"Z","ⓐ":"a","ⓑ":"b","ⓒ":"c","ⓓ":"d","ⓔ":"e","ⓕ":"f","ⓖ":"g","ⓗ":"h","ⓘ":"i","ⓙ":"j","ⓚ":"k","ⓛ":"l","ⓜ":"m","ⓝ":"n","ⓞ":"o","ⓟ":"p","ⓠ":"q","ⓡ":"r","ⓢ":"s","ⓣ":"t","ⓤ":"u","ⓥ":"v","ⓦ":"w","ⓧ":"x","ⓨ":"y","ⓩ":"z"},i=RegExp(`[${Object.keys(n).join("")}]`,"g");return e.replace(i,(e=>{for(let i in n)if(i.includes(e))return`(${n[i]})`}))}function o(e){const n={"█":"[]","ÀÁÂÃÄÅĀĂĄǍǞǠǺȀȂȦȺḀẠẢẤẦẨẪẬẮẰẲẴẶⒶⱯＡ":"A","Ꜳ":"AA","ÆǢǼ":"AE","Ꜵ":"AO","Ꜷ":"AU","ꜸꜺ":"AV","Ꜽ":"AY","ƁƂɃḂḄḆⒷＢ":"B","ÇĆĈĊČƇȻḈⒸꜾＣ":"C","ÐĎĐƉƊƋḊḌḎḐḒⒹꝹＤ":"D","ǄǅǱ":"DZ","ǅǲ":"Dz","ÈÉÊËĒĔĖĘĚƎƐȄȆȨḔḖḘḚḜẸẺẼẾỀỂỄỆⒺＥ":"E","ƑḞⒻꝻＦ":"F","ĜĞĠĢƓǤǦǴḠⒼꝽꝾꞠＧ":"G","ĤĦȞḢḤḦḨḪⒽⱧⱵꞍＨ":"H","ÌÍÎÏĨĪĬĮİƗǏȈȊḬḮỈỊⒾＩ":"I","ĴǰɈⒿＪ":"J","ĶƘǨḰḲḴⓀⱩꝀꝂꝄꞢＫ":"K","ĹĻĽĿŁȽḶḸḺḼⓁⱠⱢꝆꝈꞀＬ":"L","Ǉǈ":"LJ","ǈ":"Lj","ƜḾṀṂⓂⱮＭ":"M","ÑŃŅŇŊƝǸȠṄṆṈṊⓃꞐꞤＮ":"N","Ǌǋ":"NJ","ǋ":"Nj","ÒÓÔÕÖØŌŎŐƆƟƠǑǪǬǾȌȎȪȬȮȰṌṎṐṒỌỎỐỒỔỖỘỚỜỞỠỢⓄꝊꝌＯ":"O","Ƣ":"OI","Ꝏ":"OO","Ȣ":"OU","ƤṔṖⓅⱣꝐꝒꝔＰ":"P","ɊⓆꝖꝘＱ":"Q","ŔŖŘȐȒɌṘṚṜṞⓇⱤꝚꞂꞦＲ":"R","ŚŜŞŠȘṠṢṤṦṨẞⓈⱾꞄꞨＳ":"S","ŢŤŦƬƮȚȾṪṬṮṰⓉꞆＴ":"T","Ꜩ":"TZ","ÙÚÛÜŨŪŬŮŰŲƯǓǕǗǙǛȔȖɄṲṴṶṸṺỤỦỨỪỬỮỰⓊＵ":"U","ƲɅṼṾⓋꝞＶ":"V","Ꝡ":"VY","ŴẀẂẄẆẈⓌⱲＷ":"W","ẊẌⓍＸ":"X","ÝŶŸƳȲɎẎỲỴỶỸỾⓎＹ":"Y","ŹŻŽƵȤẐẒẔⓏⱫⱿꝢＺ":"Z","àáâãäåāăąǎǟǡǻȁȃȧɐḁẚạảấầẩẫậắằẳẵặⓐⱥａ":"a","ꜳ":"aa","æǣǽ":"ae","ꜵ":"ao","ꜷ":"au","ꜹꜻ":"av","ꜽ":"ay","ƀƃɓḃḅḇⓑｂ":"b","çćĉċčƈȼḉↄⓒꜿｃ":"c","ðďđƌɖɗḋḍḏḑḓⓓꝺｄ":"d","ǆǳ":"dz","èéêëēĕėęěǝȅȇȩɇɛḕḗḙḛḝẹẻẽếềểễệⓔｅ":"e","ƒḟⓕꝼｆ":"f","ĝğġģǥǧǵɠᵹḡⓖꝿꞡｇ":"g","ĥħȟɥḣḥḧḩḫẖⓗⱨⱶｈ":"h","ƕ":"hv","ìíîïĩīĭįıǐȉȋɨḭḯỉịⓘｉ":"i","ĵǰɉⓙｊ":"j","ķƙǩḱḳḵⓚⱪꝁꝃꝅꞣｋ":"k","ĺļľŀłſƚɫḷḹḻḽⓛⱡꝇꝉꞁｌ":"l","ǉ":"lj","ɯɱḿṁṃⓜｍ":"m","ñńņňŉŋƞǹɲṅṇṉṋⓝꞑꞥｎ":"n","ǌ":"nj","òóôõöøōŏőơǒǫǭǿȍȏȫȭȯȱɔɵṍṏṑṓọỏốồổỗộớờởỡợⓞꝋꝍｏ":"o","ƣ":"oi","ȣ":"ou","ꝏ":"oo","ƥᵽṕṗⓟꝑꝓꝕｐ":"p","ɋⓠꝗꝙｑ":"q","ŕŗřȑȓɍɽṙṛṝṟⓡꝛꞃꞧｒ":"r","ßśŝşšșȿṡṣṥṧṩẛⓢꞅꞩｓ":"s","ţťŧƭțʈṫṭṯṱẗⓣⱦꞇｔ":"t","ꜩ":"tz","ùúûüũūŭůűųưǔǖǘǚǜȕȗʉṳṵṷṹṻụủứừửữựⓤｕ":"u","ʋʌṽṿⓥꝟｖ":"v","ꝡ":"vy","ŵẁẃẅẇẉẘⓦⱳｗ":"w","ẋẍⓧｘ":"x","ýÿŷƴȳɏẏẙỳỵỷỹỿⓨｙ":"y","źżžƶȥɀẑẓẕⓩⱬꝣｚ":"z","Œ":"OE","ẞ":"SS","œ":"oe","ß":"ss"},i=RegExp(`[${Object.keys(n).join("")}]`,"g");return e.replace(i,(e=>{for(let i in n)if(i.includes(e))return n[i]}))}function u(e){const n="“",i="”",c="‘",t="’",r="…",a="•",o="©",u="®",g="™",F="–",l="—",s={[n]:'"',[i]:'"',[c]:"'",[t]:"'",[F]:"-",[l]:"-",[r]:"...","£":"GBP","«":'"',"»":'"',"‹":"'","›":"'",[a]:"*",[o]:"(c)",[u]:"(R)",[g]:"(TM)"},S=RegExp(`[${Object.keys(s).join("")}]`,"g");return e.replace(S,(e=>s[e]||""))}function g(e){return e.replace(/[^\x00-\x7F]/g,"")}}}
/* ga_html_to_md.js */
function html_to_markdown(t,e={}){const{output_table_as_text_sections:r=!1}=e,n=(t=>t?"string"==typeof t?(new DOMParser).parseFromString(t,"text/html").body:t.nodeType===Node.DOCUMENT_NODE?t.body:t.nodeType===Node.ELEMENT_NODE?t:(new DOMParser).parseFromString(t+"","text/html").body:(new DOMParser).parseFromString("","text/html").body)(t),o=t=>t.tagName.toLowerCase(),a=(t,e)=>t.getAttribute(e)||"",i=t=>Array.from(t.childNodes),l=(t,e)=>{const n=(()=>{const e=t.querySelector("caption");return e?e.textContent.trim():"untitled_table"})(),{headers:o,rows:a}=(()=>{const r=(()=>{const e=t.querySelector("thead"),r=e?e.querySelector("tr"):t.querySelector("tr");return r?Array.from(r.querySelectorAll("th, td")).map((t=>t.textContent.trim()||"column")):[]})(),n=(()=>{const e=t.querySelector("tbody")||t,r=Array.from(e.querySelectorAll("tr")),n=t.querySelector("thead")?0:1;return r.slice(n)})().map((t=>((t,r)=>Array.from(t.querySelectorAll("td, th")).reduce(((t,n,o)=>{const a=r[o]||"column_"+(o+1),l=i(n).map(e).join("").trim();return{...t,[a]:l}}),{}))(t,r))).filter((t=>Object.keys(t).length>0));return{headers:r,rows:n}})();return r?((t,e,r)=>`# ${t}\n\n`+r.map(((t,r)=>((t,r)=>`## Record ${r+1}\n\n`+e.map((e=>`### ${e}\n\n${t[e]||""}\n\n`)).join(""))(t,r))).join(""))(n,o,a):((t,e,r)=>0===e.length?`# ${t}\n\n*Empty table*\n\n`:`# ${t}\n\n| `+e.join(" | ")+" |\n| "+e.map((()=>"---")).join(" | ")+" |\n"+r.map((t=>"| "+e.map((e=>(t=>t.replace(/\n/g," ").replace(/\|/g,"\\|").trim())(t[e]||""))).join(" | ")+" |\n")).join("")+"\n")(n,o,a)},c=t=>t.trim()+"\n\n",s=t=>e=>`${t}${e}${t}`,u=t=>e=>`${"#".repeat(t)} ${e.trim()}\n\n`,m={h1:u(1),h2:u(2),h3:u(3),h4:u(4),h5:u(5),h6:u(6),p:c,div:t=>t.trim()?c(t):"",br:()=>"  \n",hr:()=>"---\n\n",blockquote:t=>t.split("\n").reduce(((t,e)=>{const r=e.trim();return r?t+(t?"\n":"")+"> "+r:t}),"")+"\n\n"},p={strong:s("**"),b:s("**"),em:s("*"),i:s("*"),code:s("`"),mark:s("=="),del:s("~~"),s:s("~~"),strike:s("~~"),span:t=>t},d=t=>{if((t=>3===t.nodeType)(t))return(t=>t.textContent.replace(/\s+/g," "))(t);if(!(t=>1===t.nodeType)(t))return"";const e=o(t),r=i(t).map(d).join("");if("table"===e)return l(t,d);if((t=>["thead","tbody","tfoot","tr","th","td","caption"].includes(t))(e))return r;if("ul"===e||"ol"===e)return((t,e)=>{const r="ol"===o(t);return Array.from(t.children).filter((t=>"li"===o(t))).map(((t,n)=>((t,e,r,n)=>`${r?e+1+".":"-"} ${n(t).trim()}`)(t,n,r,e))).join("\n")+"\n\n"})(t,d);if("li"===e)return r;if("pre"===e)return(t=>{const e=t.querySelector("code"),r=e?e.textContent:t.textContent;return`\`\`\`${(t=>t?.className.match(/language-(\w+)/)?.[1]||"")(e)}\n${r}\n\`\`\`\n\n`})(t);if("a"===e)return((t,e)=>`[${e}](${a(t,"href")})`)(t,r);if("img"===e)return(t=>{const e=a(t,"src");return`![${a(t,"alt")}](${e})`})(t);const n=m[e];if(n)return n(r);const c=p[e];return c?c(r):r};return(t=>t.replace(/\n{3,}/g,"\n\n"))((y=d(n),y.split("\n").map((t=>t.startsWith("```")||t.match(/^```/)?t:t.replace(/^\s+/,""))).join("\n"))).trim();var y}
/* ga_unzip.js */
const unzip=e=>r=>{const t=(e,r)=>e[r]|e[r+1]<<8,l=(e,r)=>(e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24)>>>0,o=(e,r,t)=>{let l=r,o=0,s=0;const n=r=>{for(;s<r;)o|=e[l++]<<s,s+=8;const t=o&(1<<r)-1;return o>>>=r,s-=r,t},f=e=>{const r=Math.max(...e),t=Array(r+1).fill(0);e.forEach((e=>e&&t[e]++));const l=[0];for(let e=1,o=0;e<=r;e++)l[e]=o=o+t[e-1]<<1;const o={};return e.forEach(((e,r)=>{e&&(o[((e,r)=>{let t=0;for(;r--;)t=t<<1|1&e,e>>>=1;return t})(l[e]++,e)+","+e]=r)})),{tbl:o,max:r}},c=e=>{for(let r=0,t=1;t<=e.max;t++)if(r|=n(1)<<t-1,void 0!==e.tbl[r+","+t])return e.tbl[r+","+t]},i=f([...Array(144).fill(8),...Array(112).fill(9),...Array(24).fill(7),...[,,,,,,,,].fill(8)]),a=f(Array(32).fill(5)),u=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],h=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],m=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],y=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],d=new Uint8Array(t);let A=0;for(;;){const r=n(1),t=n(2);if(0===t){o=s=0;let r=n(16);for(n(16);r--;)d[A++]=e[l++]}else{let e=i,r=a;if(2===t){const t=n(5)+257,l=n(5)+1,o=n(4)+4,s=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],i=Array(19).fill(0);for(let e=0;e<o;e++)i[s[e]]=n(3);const a=f(i),u=[];for(;u.length<t+l;){const e=c(a);if(e<16)u.push(e);else{const r=16===e?n(2)+3:17===e?n(3)+3:n(7)+11,t=16===e?u[u.length-1]:0;for(let e=0;e<r;e++)u.push(t)}}e=f(u.slice(0,t)),r=f(u.slice(t))}for(;;){const t=c(e);if(t<256)d[A++]=t;else{if(256===t)break;{const e=t-257,l=u[e]+n(h[e]),o=c(r),s=m[o]+n(y[o]);for(let e=0;e<l;e++)d[A]=d[A-s],A++}}}}if(r)break}return d};let s=r.length-22;for(;101010256!==l(r,s)&&--s>=0;);const n=t(r,s+10);let f=l(r,s+16);const c={};for(let s=0;s<n;s++){const s=t(r,f+10),n=l(r,f+20),i=l(r,f+24),a=t(r,f+28),u=t(r,f+30),h=t(r,f+32),m=l(r,f+42),y=(new TextDecoder).decode(r.subarray(f+46,f+46+a));if(!e?.filter||e.filter({filename:y,compressed_size:n,uncompressed_size:i,compression_method:s})){const e=m+30+t(r,m+26)+t(r,m+28);0===s?c[y]=r.slice(e,e+n):8===s&&(c[y]=o(r,e,i))}f+=46+a+u+h}return c};
/* j.js */
const g0={},el=(e=>(document.querySelectorAll`[id]`.forEach((t=>t.id&&(e[t.id]=t))),e))({}),to_markdown=html_to_markdown;function log(e){return console.log(e),e}function chain(e,...t){return t.reduce(((e,t)=>t(e)),e)}function gebi(e){return document.getElementById(e)}function plural(e,t){return t+" "+e+(1==t?"":"s")}function add_drag_drop(e){function t(e){return t=>window.addEventListener(t,e,!1)}function r(){e.classList.remove("drag")}["dragenter","dragover","dragleave","drop"].forEach(t((function(e){e.stopPropagation(),e.preventDefault()}))),["dragenter","dragover"].forEach(t((function(){e.classList.add("drag")}))),t(r)("dragleave"),t((function(t){r(),e.files=[...t.dataTransfer.files].reduce(((e,t)=>(e.items.add(t),e)),new DataTransfer).files,read_zips(t.dataTransfer)}))("drop")}function message(e){el.textarea_txt_holder.value=e}function read_zips(e){const t=[...e.files];let r=["application/epub+zip"];const a=t.filter((e=>r.includes(e.type)));if(!a[0])return message("Unaccepted file types");read_zip({i:0,files:a,thenFn:use_unzip,finallyFn:process_unzipped_files})}function read_zip({i:e,files:t,thenFn:r,finallyFn:a}){const n=t[e];n.full_name=n.name,n.ext=n.name.split(".").pop(),n.base_name=n.full_name.substring(0,n.full_name.lastIndexOf("."));const s=new FileReader;s.onload=()=>{n.data=new Uint8Array(s.result),r(n),delete n.data,e==t.length-1?a(t):read_zip({i:e+1,files:t,thenFn:r,finallyFn:a})},s.readAsArrayBuffer(n)}function use_unzip(e){function t(e){const t=e=>128==(192&e);let r=0;for(;r<e.length;){const n=(a=e[r])<=127?1:a>=194&&a<=223?2:a>=224&&a<=239?3:a>=240&&a<=244?4:0;if(0===n||r+n>e.length)return!1;if(!e.slice(r+1,r+n).every(t))return!1;r+=n}var a;return!0}const r=unzip()(e.data);e.files=[];for(const n in r){if(!r.hasOwnProperty(n))continue;let s={path:n,full_name:n.split("/").pop(),ext:n.split(".").pop(),data:t(r[n])?(a=r[n],new TextDecoder("utf-8").decode(a)):r[n]};s.base_name=s.full_name.substring(0,s.full_name.lastIndexOf(".")),e.files.push(s)}var a;return e}function process_unzipped_files(e){e.forEach(process_book),g0.summary=plural("Converted EPUB",e.length),g0.unzipped=e,message(`Processed ${g0.summary}:\n`+g0.unzipped.reduce(((e,t)=>e+(t.best_name+"\n")),""));let t=[];if(g0.unzipped.forEach((e=>{e.chapters.forEach((r=>{t.push({name:r.file_name_title+"."+r.processed_ext,data:r.processed_data,path:e.best_name+"/"})}))})),el.auto_save.checked){let a=tar_lib.data_to_tar_blob(t,!(g0.unzipped.length<2)&&g0.summary);function r(){tar_lib.save_blob({blob:a,name:g0.summary+".tar"})}r(),el.save_button.disabled=!1,el.save_button.hidden=!1,el.save_button.onclick=r}else el.save_button.disabled=!1,el.save_button.hidden=!1,el.save_button.onclick=()=>{let e=tar_lib.data_to_tar_blob(t,!(g0.unzipped.length<2)&&g0.summary);tar_lib.save_blob({blob:e,name:g0.summary+".tar"})}}function parse_opf(e){const t=(new DOMParser).parseFromString(e,"application/xml");return t.getElementsByTagName("parsererror").length>0?(log("Error parsing OPF string"),!1):t}function get_meta(e){return e?[...e.querySelectorAll("*")].reduce(((e,t)=>{let r=t.tagName.toLowerCase().startsWith("dc:"),a=void 0!==t.id&&t.id.length>0;if(!r&&!a)return e;let n=t.textContent.trim();if(0==n.length)return e;let s=r?t.tagName.replace(/dc:/gi,""):"",l=a?t.id.replace(RegExp(`^${s}-*`,"i"),"").replaceAll("-","_"):"";return e[(s+(r&&l.length>0?"_":"")+l).toLowerCase().trim()]=chain(n,process_text({ascii_wanted:el.make_content_ascii.checked})).trim(),e}),{}):{}}function process_book(e){let t=chain(e.files.filter((e=>"opf"==e.ext))[0].data,parse_opf);e.meta=get_meta(t),e.chapter_order=parse_epub_order(t);let r=e.files.reduce(((e,t)=>["xhtml","html"].includes(t.ext)?(e[t.full_name]=process_chapter(t),e):e),{});const a=(e=>{const t=(e.length+"").length;return e=>(e+"").padStart(t,"0")})(e.chapter_order);e.chapters=e.chapter_order.reduce(((e,t)=>{let n=r[t];return!n||n.is_empty||(e.push(n),n.file_name_title=slugify(a(e.length+"")+(n.title.trim().length>0?" "+n.title:""))),e}),[]);{let t=e.chapters.reduce(((e,t)=>(e.push(t.processed_data),e)),[]).join("\n\n");e.chapters.push({file_name_title:"_single_file_book",processed_data:t,processed_ext:"md"})}e.chapters.push({file_name_title:"00 Meta",processed_data:JSON.stringify(e.meta,null,"\t"),processed_ext:"json"}),e.best_name=get_best_book_name(e)}function get_best_book_name(e){let t=e.meta.author||e.meta.creator_author||e.meta.creator||e.base_name;return(r=t+" - "+(e.meta.title||(t==e.base_name?"":e.base_name))).length>48?r.substring(0,48):r;var r}function base_name_and_ext_from_path(e){return e.split("/").pop()}function parse_epub_order(e){const t=[...e.querySelectorAll("manifest > item")],r=[...e.querySelectorAll("spine > itemref")],a=t.reduce(((e,t)=>{const r=base_name_and_ext_from_path(t.getAttribute("href"));return e[t.getAttribute("id")]=r,e}),{});return r.map((e=>a[e.getAttribute("idref")]))}function slugify(e){if("string"!=typeof e)return"";let t=e.trim();return 0===t.length?"":(t=t.toLowerCase().replace(/\s+/g,"-").replace(/[^A-Za-z0-9_-]/g,"").replace(/-+/g,"-").replace(/^[-_]+|[-_]+$/g,"").replace(/^[^A-Za-z0-9]+/,"").replace(/[^A-Za-z0-9]+$/,"").replaceAll("-"," "),t&&/^[A-Za-z0-9].*[A-Za-z0-9]$/.test(t)?t:"")}function process_chapter(e){const t=(new DOMParser).parseFromString(e.data,"application/xhtml+xml");return e.processed_data=chain(t.body,to_markdown,process_text({ascii_wanted:el.make_content_ascii.checked})).trim(),e.processed_ext="md",e.is_empty=0===e.processed_data.length,e.is_empty||(e.title=[...t.body.querySelectorAll("h1,h2,h3,h4,h5,h6")].map((e=>e.textContent.trim())).filter((e=>e.length>0))[0]?.trim()||"",e.title=process_text({ascii_wanted:!0})(e.title)),e}el.file_picker.addEventListener("change",(e=>read_zips(e.target))),add_drag_drop(el.file_picker);</script></body></html>